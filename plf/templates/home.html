{% extends "base.html" %}

{% block content %}

  {% for item in items %}
    {% if item.status == True %}
      <div class="masonryImage lost blocky" value={{ item.id }}>
    {% else %}
      <div class="masonryImage found blocky" value={{ item.id }}>
    {% endif %}
    {% if item.picture %}
      <img src="..{{ item.picture.url }}" class="tileim"/>
    {% endif %}
      <p class="name">{{ item.name  }}</p>
      <p class="small-header">{{ item.location }}</p>
      <hr class="break"/>
    {% if item.status == True %}
      <p class="location">Lost
    {% else %}
      <p class="location">Found
    {% endif %}
<<<<<<< HEAD
    {% if item.event_date %}
      : {{ item.event_date }}
    {% endif %}
    </p>

    <p class="location">{{ item.desc }}</p>
=======
      : {{ item.event_date }}</p>
    <div class="desc">
      <p class="location desc">{{ item.desc }}</p>
    </div>
>>>>>>> stuff

   {% if item.status == True %}
      <button class="btn btn-mini pop" value="{{ item.id }}" name="{{ item.status }}">I Found This!</button>
   {% else %}
      <button class="btn btn-mini pop" value="{{ item.id }}" name="{{ item.status }}">This is Mine!</button>
   {% endif %}
  </div>
 {% endfor %}

 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
 <script src="../media/jquery.isotope.min.js"></script>
 
 <script>
  $('#right').imagesLoaded( function() {
    var $but = $('.btn.btn-mini');
    $but.click( function() {
      $('.modal-footer.claiming #id').val(this.value);
      $('.modal-footer.claiming #status').val(this.name);
      $('#claimModal').modal("show");
    })

    {% if errors %}
      $('#submitModal').modal("show");
    {% endif %}

    $('.btn.btn-mini.pop').popover({ placement: 'right', trigger: 'hover', content: 'Login to claim items'});
    $('#myItemsPopover').popover({ placement: 'right', trigger: 'hover', content: 'Login to view your items'});
    $('#submitPopover').popover({ placement: 'right', trigger: 'click', content: 'Login to submit'});
  });
 </script>

 <script>
 /* case insensitivity */
 jQuery.expr[":"].Contains = jQuery.expr.createPseudo(function(arg) {
    return function( elem ) {
    return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
    };
 });

/* create location mappings -- e.g. "Forbes College" == "Forbes" */
var locMappings = new Array();
locMappings[0] = "Forbes\nForbes College\nForbes Main Inn\nForbes Annex\nForbes Addition";
locMappings[1] = "Rocky\nRockefeller\nRocky College\nRockefeller College";
locMappings[2] = "Whitman\nWhitman College";
locMappings[3] = "Wilson\nWilson College";
locMappings[4] = "Firestone\nFirestone Library";
locMappings[5] = "Frist\nFrist Campus Center\nFrist Center";
locMappings[6] = "Butler\nButler College";

 function monthToDays(month) {
  var d;
  switch(month) {
    case 1:
      d = 0;
      break;
    case 2:
      d = 31;
      break;
    case 3:
      d = 31+28;
      break;
    case 4:
      d = 31+28+31;
      break;
    case 5:
      d = 31+28+31+30;
      break;
    case 6:
      d = 31+28+31+30+31;
      break;
    case 7:
      d = 31+28+31+30+31+30;
      break;
    case 8:
      d = 31+28+31+30+31+30+31;
      break;
    case 9:
      d = 31+28+31+30+31+30+31+31;
      break;
    case 10:
      d = 31+28+31+30+31+30+31+31+30;
      break;
    case 11:
      d = 31+28+31+30+31+30+31+31+30+31;
      break;
    case 12:
      d = 31+28+31+30+31+30+31+31+30+31+30;
      break;
    default:
      d = 0;
      break;
  }
  return d;
}

 $(function() {
   var $container = $('#right');

   $container.imagesLoaded( function() {
      var $location = $('#loc');
      original_loc = $location.val();
      $location.focus(function(){
        if($(this).val()===original_loc){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_loc);
        }
      });

      var $title = $('#title');
      original_tit = $title.val();
      $title.focus(function(){
        if($(this).val()===original_tit){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_tit);
        }
      });

      var $search = $('#search');
      original_val = $search.val();
      $search.focus(function(){
        if($(this).val()===original_val){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_val);
        }
      });
      /* $search.keypress(function(){
        alert("blah");
        if($(this).val()===''){
          $container.isotope({ 

          });
        } 
      }); */

      $search.keyup(function(e) {
        if (e.keyCode == 8) {
          /*$('.masonryImage').each(function() {
            if ($(this).is(":contains('" + input + "')")) {
                $(this).removeClass('shown');
            }
          });*/
          $container.isotope({filter: "*"});
          return false;
        }
      });
      $search.keypress(function (e) {
        if (e.which == 13) {
          /* do the searching here */
          /* make the http request for json data, then parse */
          var ret;
          var count = 0;
          var input = $(this).val();
          /*
          $.getJSON("../data/", function(ret){
            $.each(ret, function(index, item){

              if (item.fields.category===input) {
                $('.masonryImage').each(function() {
                  if ($(this).attr("value")==item.pk) {
                    $(this).addClass('shown');
                    count++;
                  }
                })
              }
            });
          });*/
          /* see if input matches an extant mapping */
          var x;
          var matched = 0;
          for (var i = 0; i < locMappings.length; i++) {
            x = locMappings[i].split('\n');
            for (var j = 0; j < x.length; j++) {
              if (input.toLowerCase() == x[j].toLowerCase()) {
                matched = 1;
              }
            }
            if (matched == 1) break;
          }
          /* x is now mapping that matches */

          $('.masonryImage').each(function() {
            if (matched == 1) {
              for (var k = 0; k < x.length; k++) {
                var test = x[k].toLowerCase();
                if ($(this).is(":Contains('" + test + "')")) {
                  $(this).addClass('shown');
                  count++;
                }
              }
            }
            else {
              if ($(this).is(":Contains('" + input.toLowerCase() + "')")) {
                $(this).addClass('shown');
                count++;
              }
            }
            });
            if (count === 0) {
               alert("No items match your search criteria.");
            }
            else {
             $container.isotope({ filter: ".shown"});
              $('.masonryImage').each(function() {
                if ($(this).hasClass('shown')) {
                $(this).removeClass('shown');
                }
              });
            }

          return false;
        }
      });  

      $container.isotope({

      });

      $('#filters a').click(function(){
        var selector = $(this).attr('data-filter');
        $container.isotope({ filter: selector });
        return false;
      });

      $('#advSearch').click(function() {
        var location = $('#loc').val();
        var name = $('#title').val();
        var category = $('#cats').val();
        var date = $('#date').val();
        var descbox = $('#descbox').val();
        var lost = $('#lf1').is(":checked");
        var found = $('#lf2').is(":checked");
        var nd = $('#1d').is(":checked");
        var fd = $('#fd').is(":checked");
        var nw = $('#1w').is(":checked");
        var nm = $('#1m').is(":checked");
        var locY;
        var nameY;
        var catY; 
        var dateY;
        var descY;

        if (location!="e.g. Frist") {
          locY = true;
        }
        else locY = false;
        if (name!="e.g. Black North Face Jacket") {nameY = true;}
        else nameY = false;
        if (category!=null) {catY = true;}
        else catY = false;
        if (date!="") {dateY = true;}
        else dateY = false;
        if (descbox!="") {descY = true;}
        else descY = false;

        var ret;
        var count = 0;
        var keywords = descbox.split("\n");
        var namewords = name.split(" ");
          
        $.getJSON("../data/", function(ret){
          $.each(ret, function(index, item){
           /* alert('item');
            alert('locY'+locY);
            alert('location field' + )
            alert('nameY' + nameY);
            alert('catY' + catY);
            alert('dateY' + dateY);
            alert(lost + 'field:' + item.fields.status)*/

            if (lost && !item.fields.status) {return true;}
            if (found && item.fields.status) {return true;}

            if (catY && item.fields.category!=category[0]) return true;
            if (locY && item.fields.location!=location) return true;

            /* date handling */
            if (item.fields.event_date==null) return true;
            if ((nd && dateY) && (item.fields.event_date!=date)) return true;
            if ((fd || nw) || nm) {
              if (dateY) {
                /* e is event, f is form input - 10 is to prevent octal */
                var eDay = parseInt(item.fields.event_date.substring(8, 10), 10);
                var fDay = parseInt(date.substring(8, 10), 10);
                var eMonth = parseInt(item.fields.event_date.substring(5, 7), 10);
                var fMonth = parseInt(date.substring(5, 7), 10);
                var eYear = parseInt(item.fields.event_date.substring(0, 4), 10);
                var fYear = parseInt(date.substring(0, 4), 10);
                /* convert date to easier format */
                var eDayVal = monthToDays(eMonth) + eDay; //+ eYear*365;
                var fDayVal = monthToDays(fMonth) + fDay; // + fYear*365;

                var dist = Math.abs(fDayVal-eDayVal);
                if (dist > 365) dist = dist - 365; // seems to work
                if (fd && (dist > 3)) {
                  return true;
                }
                if (nw && (dist > 7)) {
                  return true;
                }
                if (nm && (dist > 30)) {
                  return true;
                }
                if (eYear != fYear) {
                  return true;
                }
              }
            }


            if (nameY) {
              var find = false;
              $.each(namewords, function(index, element){
                var blah = item.fields.name.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (descY) {
              var find = false;
              $.each(keywords, function(index, element){
                var blah = item.fields.desc.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

          /* I don't know why this needs to be here */
          $('.masonryImage').each(function() {
              if ($(this).attr("value")==item.pk) {
                $(this).addClass('shown');
                  count++;
              }
           });


          });
            $container.isotope({ filter: ".shown"});
             /* reset */
            $('.masonryImage').each(function() {
              if ($(this).hasClass('shown')) {
                $(this).removeClass('shown');
              }
            });

        });
        return false;
      });

    });
  });

</script>

{% endblock %}
