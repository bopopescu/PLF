{% extends "base.html" %}

{% block content %}

  {% for item in items %}
    {% if forloop.counter < 5 %}
    {% if item.status == True %}
      <div class="masonryImage lost blocky low-priority" value="{{ item.id }}">
    {% else %}
      <div class="masonryImage found blocky low-priority" value="{{ item.id }}">
    {% endif %}

    {% if item.picture %}
      <img src="{{ item.picture.url }}" class="tileim low-priority"/>
    {% endif %}
      <p class="name" style="font-size: 20px">{{ item.name  }}</p>
      <p class="small-header">{{ item.location }}</p>

    {% if item.status == True %}
      <hr class="break lost line"/>
    {% else %}
      <hr class="break found line"/>
    {% endif %}

    <u>
    {% if item.status == True %}
      <p class="location">Lost
    {% else %}
      <p class="location">Found
    {% endif %}
    {% if item.event_date %}
      : {{ item.event_date }}
    {% endif %}
    </p></u>
    <div class="desc">
      <p class="location desc">{{ item.desc }}</p>
    </div>

    {% if must_log_in == True %}
      <button href="../login" class="btn btn-mini claim">Login to claim</button>
    {% else %}
      {% if item.status == True %}
        <button href="#claimModal1" data-toggle="modal" class="btn btn-mini claim" value="{{ item.id }}" name="{{ item.status }}">I Found This</button>
      {% else %}
        <button href="#claimModal1" class="btn btn-mini claim" data-toggle="modal" value="{{ item.id }}" name="{{ item.status }}">This is Mine</button>
      {% endif %}
    {% endif %}
    {% endif %}
  </div>
 {% endfor %}


<div class="container-fluid">
  <div class="row-fluid">
    <div class="span6" style="float: right; text-align:center; padding-top: 5px">
  <button class="btn btn-mini claim">show more...</button>
    </div>
  </div>
</div>


 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
 <script src="../static/jquery.isotope.min.js"></script>

 <script>


$(function() {
  var $container = $('#right');

  $(document).ready(function(){ 

    /* serialize the form information and search existing items */
    var checkForMatches = 1;
    /*
    $('#yo').submit(function() {
    if (checkForMatches == 0) {
      return;
    }
      var myobj = $(this).serializeArray();
      var loc='';
      var name='';
      var cat='';
      var date='';
      var desc='';
      var lost='';
      var found='';

      $.each(myobj, function(ind, indVal){

        if (indVal.name == 'status') {
          if (indVal.value == 'Lost') {
            found = true;
          }
          else if (indVal.value == 'Found') {
            lost = true;
          }
        }
        if (indVal.name == 'name') {
          name = indVal.value;
        }
        if (indVal.name == 'loc') {
          loc = indVal.value;
        }
        if (indVal.name == 'category') {
          cat = indVal.value;
        }
        if (indVal.name == 'event_date') {
          date = indVal.value;
        }
        if (indVal.name == 'desc') {
          desc = indVal.desc;
        }
      });
      if (((!found && !lost) || name=='') || desc=='') {
        $('#submitModal').modal("show");
        return;
      }

        var locY;
        var nameY;
        var catY; 
        var dateY;
        var descY;
        var nw = true;
        var fd = false;
        var nm = false;

        if (loc!='') {locY = true;}

        else locY = false;
        if (name!='') {nameY = true;}
        else nameY = false;
        if (cat!='') {catY = true;}
        else catY = false;
        if (date!='') {dateY = true;}
        else dateY = false;
        
        descY = false;

        var ret;
        var count = 0;
        var namewords = name.split(" ");
        var locwords = loc.split(" ");

        $.getJSON("../data/", function(ret) {
          $.each(ret, function(index, item){

            if (lost && !item.fields.status) {return true;}
            if (found && item.fields.status) {return true;}

            if (catY && item.fields.category!=cat) return true;

            if (item.fields.event_date==null && dateY) return true;

            if ((fd || nw) || nm) {

              if (dateY) {

                var eDay = parseInt(item.fields.event_date.substring(8, 10), 10);
                var fDay = parseInt(date.substring(8, 10), 10);
                var eMonth = parseInt(item.fields.event_date.substring(5, 7), 10);
                var fMonth = parseInt(date.substring(5, 7), 10);
                var eYear = parseInt(item.fields.event_date.substring(0, 4), 10);
                var fYear = parseInt(date.substring(0, 4), 10);
                var eDayVal = monthToDays(eMonth) + eDay; //+ eYear*365;
                var fDayVal = monthToDays(fMonth) + fDay; // + fYear*365;

                var dist = Math.abs(fDayVal-eDayVal);
                if (dist > 365) dist = dist - 365; // seems to work
                if (fd && (dist > 3)) {
                  return true;
                }
                if (nw && (dist > 7)) {
                  return true;
                }
                if (nm && (dist > 30)) {
                  return true;
                }
                if (eYear != fYear) {
                  return true;
                }
              }
            }

            if (nameY) {
              var find = false;
              $.each(namewords, function(index, element){
                var blah = item.fields.name.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (locY) {
              var find = false;
              $.each(locwords, function(index, element){
                var blah = item.fields.location.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (descY) {
              var find = false;
              $.each(keywords, function(index, element){
                var blah = item.fields.desc.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

          $('.masonryImage').each(function() {
              if ($(this).attr("value")==item.pk) {
                $(this).addClass('shown');
                  count++;
              }
           });
        });
        // pop up new modal - show them
        if (count > 0) {
          var html = $('.shown:first').html();
          html = html.replace("claimModal1", "claimModal");
          html = html.replace(/<img src=(.)*>/, "");
          $('#matchModal').append("<div class=\'masonryImage\'>" + html + "</div>");

          alert($('.shown:first').text().length);

          if (count > 1 && $('.shown:first').text().length+$('.shown').eq(1).text().length < 400) {
            html = $('.shown').eq(1).html();
            html = html.replace(/<img src=(.)*>/, "");
            html = html.replace("claimModal1", "claimModal");
            $('#matchModal').append("<div class=\'masonryImage\'>" + html + "</div>");
          }
          $('#matchModal').modal("show");
        }
        $('.masonryImage').each(function() {
          if ($(this).hasClass('shown')) {
            $(this).removeClass('shown');
          }
        });
        if (count == 0) {
          checkForMatches = 0;
          $('#yo').submit();
          checkForMatches = 1;
          return;
        }
      });
      return false;
    });*/
    /*
    $('#matchsub').click(function() {
      checkForMatches = 0;
      $('#yo').submit();
      checkForMatches = 1;
    });*/

    // Open submit modal upon reloading if errors occurred
    {% if errors %}
      $('#submitModal').modal("show");
    {% endif %}

    // pass data to claim modal
    $('.btn.btn-mini.claim').click( function() {
      $('.modal-footer.claiming #id').val(this.value);
      $('.modal-footer.claiming #status').val(this.name);
    });
    /*
    $('#matchModal').on('show', function() {
      $('.btn.btn-mini.claim').click( function() {
        $('.modal-footer.claiming #id').val(this.value);
        $('.modal-footer.claiming #status').val(this.name);
      });
    });*/

      $('#noemail').click(function() {
        $('#claimModal').modal('hide');
      });
      $('#noemail1').click(function() {
        $('#claimModal').modal('hide');
      });

      $('#nomatch').click(function() {
        $('#matchModal').modal('hide');
        $('#matchModal .masonryImage').remove();
      });

    {% if options != 0 %}
      $('#thanksModal').modal("show");
    {% endif %}

    // pass data to resolve modal

    var $res = $('.btn.btn-mini.resolve');
    $res.click( function() {
      $('.modal-footer.resolving #id').val(this.value);
    });
  });
  $container.imagesLoaded( function() {


      var $location = $('#loc');
      original_loc = $location.val();
      $location.focus(function(){
        if($(this).val()===original_loc){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_loc);
        }
      });

      var $title = $('#title');
      original_tit = $title.val();
      $title.focus(function(){
        if($(this).val()===original_tit){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_tit);
        }
      });

      var $search = $('#search');
      original_val = $search.val();
      $search.focus(function(){
        if($(this).val()===original_val){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_val);
        }
      });
      /* $search.keypress(function(){
        if($(this).val()===''){
          $container.isotope({ 

          });
        } 
      }); */
      var thread = null;
      function serverSearch(call, input) {
          $.getJSON(call, { 'val': input}).done(function(ret){
            var newItems;
            var html = "";
            $.each(ret, function(index, item){
              if (item.fields.status == true) {
                html += "<div class='masonryImage lost blocky low-priority shown' value ='" + item.pk + "'>";
              }
              else {
                html += "<div class='masonryImage found blocky low-priority shown' value ='" + item.pk + "'>";
              }
              if (item.fields.picture.toString() != '') {
                html += "<img src='../media/" + item.fields.picture + "' class='tileim low-priority'/>";
              }
              html += "<p class='name' style='font-size: 20px'>" + item.fields.name + "</p><p class='small-header'>" + item.fields.location + "</p>";
              html += "<u>";
              if (item.fields.status.toString() == 'true') {
                html += "<hr class='break lost line'/><p class='location'>Lost";
              }
              else {
                html += "<hr class='break found line'/><p class='location'>Found";
              }
              if (item.fields.event_date) {
                html += ": " + item.fields.event_date;
              }
              html += "</u>";
              html += "</p></u><div class='desc'><p class='location desc'>" + item.fields.desc + "</p></div>";
              
              {% if must_log_in == True %}
                html += "<button href='../login' class='btn btn-mini claim'>Login to claim</button>";
              {% else %}
                if (item.fields.status == 'True') {
                  html += "<button href='#claimModal1' data-toggle='modal' class='btn btn-mini claim' value='" + item.pk + "' name='" + item.fields.status + "'>I Found This</button>";
                }
                else {
                  html += "<button href='#claimModal1' class='btn btn-mini claim' data-toggle='modal' value='" + item.pk + "' name='" + item.fields.status + "'>This is Mine</button>";
                }
              {% endif %}
              html += "</div>";
            });
            newItems = $.parseHTML(html);
            $('.masonryImage').each(function() {
              $container.isotope('remove', $(this));
            });
            $container.isotope('insert', $(newItems));
            $container.isotope({ filter: ".shown"});
          });
      }
      $search.keyup(function(e) {
        if (e.which == 13) {
          return;
        }
        clearTimeout(thread);
        if (e.which == 8) {
          $('.masonryImage.shown').each(function() {
            $container.isotope('remove', $(this));
          });
          $container.isotope({filter: "*"});
          return false;
        }
        else {

          var input = $(this).val().toString();

          thread = setTimeout(function() {
            serverSearch("../search/", input);
          }, 300);
        }
      });

      $('.search-indent').submit(function(e) {
        e.preventDefault();
      });
      
      $container.isotope({

      });

      $('#filters a').click(function(){
        var selector = $(this).attr('data-filter');
        if (selector == '*') {
          // reset to the most recent whatever, like 5
          var input = '[]';
          serverSearch('../default/', input);
        }
        $container.isotope({ filter: selector });
        return false;
      });

      $('#advSearch').click(function() {
        var location = $('#loc').val();
        var name = $('#title').val();
        var category = $('#cats').val();
        var date = $('#date').val();
        var descbox = $('#descbox').val();
        var status = $('input:radio[name="lf"]:checked').val();
        var date_range = $('input:radio[name=range]:checked').val();

        // so we can do csv to pass data
        name = name.replace(',', '')
        descbox = descbox.replace(',', '')

        var input = location + ',' + name + ',' + 
                    category + ',' + date + ',' +
                    descbox + ',' + status + ',' +
                    date_range;

        serverSearch('../advSearch/', input);

        /*var locY;
        var nameY;
        var catY; 
        var dateY;
        var descY;

        if (location!="e.g. Frist") {
          locY = true;
        }
        else locY = false;
        if (name!="e.g. Black North Face Jacket") {nameY = true;}
        else nameY = false;
        if (category!=null && category != "Any") {catY = true;}
        else catY = false;
        if (date!="") {dateY = true;}
        else dateY = false;
        if (descbox!="") {descY = true;}
        else descY = false;

        var ret;
        var count = 0;
        var keywords = descbox.split("\n");
        var namewords = name.split(" ");
        var locwords = location.split(" ");

        $.getJSON("../data/", function(ret){
          $.each(ret, function(index, item){

            if (lost && !item.fields.status) {return true;}
            if (found && item.fields.status) {return true;}

            if (catY && item.fields.category!=category[0]) return true;

            if (item.fields.event_date==null && dateY) return true;
            if ((nd && dateY) && (item.fields.event_date!=date)) return true;
            if ((fd || nw) || nm) {
              if (dateY) {
                var eDay = parseInt(item.fields.event_date.substring(8, 10), 10);
                var fDay = parseInt(date.substring(8, 10), 10);
                var eMonth = parseInt(item.fields.event_date.substring(5, 7), 10);
                var fMonth = parseInt(date.substring(5, 7), 10);
                var eYear = parseInt(item.fields.event_date.substring(0, 4), 10);
                var fYear = parseInt(date.substring(0, 4), 10);

                var eDayVal = monthToDays(eMonth) + eDay; //+ eYear*365;
                var fDayVal = monthToDays(fMonth) + fDay; // + fYear*365;

                var dist = Math.abs(fDayVal-eDayVal);
                if (dist > 365) dist = dist - 365; // seems to work
                if (fd && (dist > 3)) {
                  return true;
                }
                if (nw && (dist > 7)) {
                  return true;
                }
                if (nm && (dist > 30)) {
                  return true;
                }
                if (eYear != fYear) {
                  return true;
                }
              }
            }


            if (nameY) {
              var find = false;
              $.each(namewords, function(index, element){
                var blah = item.fields.name.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (locY) {
              var find = false;
              $.each(locwords, function(index, element){
                var blah = item.fields.location.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (descY) {
              var find = false;
              $.each(keywords, function(index, element){
                var blah = item.fields.desc.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

          $('.masonryImage').each(function() {
              if ($(this).attr("value")==item.pk) {
                $(this).addClass('shown');
                  count++;
              }
           });


          });
            $container.isotope({ filter: ".shown"});

            $('.masonryImage').each(function() {
              if ($(this).hasClass('shown')) {
                $(this).removeClass('shown');
              }
            });

        });*/
        return false;
      });

    });
  });

</script>

{% endblock %}
