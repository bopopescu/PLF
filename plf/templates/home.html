{% extends "base.html" %}

{% block content %}

  {% for item in items %}
    {% if item.status == True %}
      <div class="masonryImage lost blocky low-priority" value="{{ item.id }}">

    {% else %}
      <div class="masonryImage found blocky low-priority" value="{{ item.id }}">
    {% endif %}
    {% if item.picture %}
      <img src="{{ item.picture.url }}" class="tileim low-priority"/>
    {% endif %}
      <p class="name">{{ item.name  }}</p>
      <p class="small-header">{{ item.location }}</p>

    {% if item.status == True %}
      <hr class="break lost line"/>
    {% else %}
      <hr class="break found line"/>
    {% endif %}

    {% if item.status == True %}
      <p class="location">Lost
    {% else %}
      <p class="location">Found
    {% endif %}
    {% if item.event_date %}
      : {{ item.event_date }}
    {% endif %}
    </p>
    <div class="desc">
      <p class="location desc">{{ item.desc }}</p>
    </div>

    {% if must_log_in == True %}
      <a href="../login" class="btn btn-mini">Login to claim</a>
    {% else %}
      {% if item.status == True %}
        <button href="#claimModal" data-toggle="modal" class="btn btn-mini claim" value="{{ item.id }}" name="{{ item.status }}">I Found This!</button>
      {% else %}
        <button href="#claimModal" class="btn btn-mini claim" data-toggle="modal" value="{{ item.id }}" name="{{ item.status }}">This is Mine!</button>
      {% endif %}
    {% endif %}
  </div>
 {% endfor %}

 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
 <script src="../static/jquery.isotope.min.js"></script>

 <script>
 /* case insensitivity */
 jQuery.expr[":"].Contains = jQuery.expr.createPseudo(function(arg) {
    return function( elem ) {
    return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
    };
 });

/* create location mappings -- e.g. "Forbes College" == "Forbes" */
var locMappings = new Array();
locMappings[0] = "Forbes\nForbes College\nForbes Main Inn\nForbes Annex\nForbes Addition\nMain Inn\nAnnex\nAddition\n4BZ\nPink House";
locMappings[1] = "Rocky\nRockefeller\nRocky College\nRockefeller College\nMadison\nMadison Hall\nHamilton\nHamilton Hall\nHolder\nHolder Hall\nBuyers\nBuyers Hall\nWitherspoon\nWitherspoon Hall\nCampbell\nCampbell Hall";
locMappings[2] = "Whitman\nWhitman College\nFisher\nFisher Hall\nWendell\nWendell Hall\nCommunity\nCommunity Hall\nMurley-Pivirotto\nHargadon\nHargadon Hall\nLauritzen\nLauritzen Hall\nBaker\nBaker Hall\n1981\n1981 Hall";
locMappings[3] = "Wilson\nWilson College\nFeinberg\nFeinberg Hall\nWalker\nWalker Hall\n1937\n1937 Hall\nDodge\nOsborn\nDodge-Osborn\nDodge-Osborn Hall\n1938\n1938 Hall\n1939\n1939 Hall\nChristian Gauss Hall\nGauss\nGauss Hall\n1927\n1927-Clapp\nClapp\nClapp Hall\n1927 Hall\nWilcox\nWilcox Hall";
locMappings[4] = "Mathey\nMathey College\nCampbell\nCampbell Hall\nJoline\nJoline Hall\nBlair\nBlair Hall\nBlair Arch\nHamilton\nHamilton Hall\nEdwards\nEdwards Hall\nLittle\nLittle Hall";
locMappings[5] = "Butler\nButler College\nYoseloff\nYoseloff Hall\n1967\n1967 Hall\nBloomberg\nBloomberg Hall\nBogle\nBogle Hall\n1976\n1976 Hall\nWilf\nWilf Hall\nWu\nWu Hall\nScully\nScully Hall";
locMappings[6] = "Charter\nCharter Club";
locMappings[7] = "Cloister\nCloister Club";
locMappings[8] = "Cap & Gown\nCap and Gown\nCap & Gown Club\nCap and Gown Club\nCap Gown\nCap\nCap Club";
locMappings[9] = "Cottage\nCottage Club";
locMappings[10] = "Ivy\nIvy Club";
locMappings[11] = "Tiger Inn\nTI\nT.I.\nTI Club\nTiger Inn Club";
locMappings[12] = "Colonial\nColonial Club\nCoronial";
locMappings[13] = "Quadrangle\nQuad\nQuadrangle Club\nQuad Club";
locMappings[14] = "Cannon\nCannon Dial Elm\nCDE\nCDE Club\nCannon Club";
locMappings[15] = "Tower\nTower Club";
locMappings[16] = "Campus\nCampus Club";
locMappings[17] = "Terrace\nTerrace Club\nFOOD=LOVE";
locMappings[18] = "CJL\nCenter for Jewish Life\nJewish Life";
locMappings[19] = "Prospect\nProspect Avenue\nThe Street\nStreet\nProspect Street\nFields Center\nCarl Fields\nCarl Fields Center";
locMappings[20] = "Firestone\nFirestone Library";
locMappings[21] = "Frist\nFrist Campus Center\nFrist Center\nFirst\nFirst Center\nFirst Campus Center\nCampus Center";
locMappings[22] = "Robertson\nRobertson Hall\nWoodrow Wilson\nWoody Woo\nWoodrow Wilson Building\nPlaza\nFountain";
locMappings[23] = "Bendheim\nBendheim Finance\nCorwin\nCorwin Hall";
locMappings[24] = "Chapel\nChurch";
locMappings[25] = "Dickinson\nDickinson Hall\nDickenson\nDickenson Hall\nMcCosh\nMcCosh Hall";
locMappings[26] = "Brown\nBrown Hall\nCuyler\n1903\nWright\nPatton";
locMappings[27] = "Marx\nMarx Hall\n1879\n1879 Hall\nArchitecture Building\nArchitecture\nWoolworth\nMusic\nMusic Building";
locMappings[28] = "Prospect\nProspect House\nProspect Garden\nProspect Gardens";
locMappings[29] = "Clio\nClio Hall\nWhig\nWhig Hall";
locMappings[30] = "Dillon\nDillon Gym\nGym\nBasketball\nNatatorium\nFitness\nMPR\nGFR\nMAR\nDillon West\nDillon East";
locMappings[31] = "Spellman\nSpelman\nSpelman Hall";
locMappings[32] = "Graduate College\nGrad College\nGraduate\nCleveland Tower\nCleveland\nProcter\nProcter Hall\nOld Graduate College\nNew Graduate College\nWyman Cottage\nWyman\nWyman House\nWest Lodge";
locMappings[33] = "Jadwin\nMcDonnell\nMcDonnell Hall\nJadwin Hall";
locMappings[34] = "Fine\nFine Hall\nFine Tower\n";
locMappings[35] = "Frick\nFrick Chemistry Lab\nFrick Labs";
locMappings[36] = "McCormick\nArt\nArt Museum\nMuseum\nMcCormick Library";
locMappings[37] = "McCarter\nMcCarter Theater\nMcCarter Theatre\nBerlind\nBerlind Theatre\nBerline Theater";
locMappings[38] = "Poe Field\nPoe\n1912\n1912 Pavilion\nLourie\nLove Pavilion\nPardee Field\nWest Pavilion";
locMappings[39] = "U-Store\nU Store\nUniversity Store\nLockhart\nLockhart Hall\nCareer Services\nCareer\nFoulke\nFoulke Hall";
locMappings[40] = "Henry\nHenry Hall\nLaughlin\nLaughlin Hall\n1901\n1901 Hall\nPyne\nPyne Hall\nJunior\nJunior Slums";
locMappings[41] = "Wa\nWaWa\nThe Wa\nDinky\nNJ Transit\nTrain\nTrain Station\nNew South";
locMappings[42] = "Thomas\nThomas Hall\nIcahn\nIcahn Lab\nIcahn Laboratory";
locMappings[43] = "Guyot\nGuyot Hall\nMoffett\nMoffett Hall\nSchultz\nSchultz Hall";
locMappings[44] = "Nassau\nNassau Hall\nEast Pyne\nChancellor Green\nStanhope\nMaclean";
locMappings[45] = "Richardson\nRichardson Auditorium\nAlexander\nAlexander Hall";
locMappings[46] = "Roberts Stadium\nMyslik\nPlummer\nGulick\nCordish\nLenz\nTennis\n1952\nSherrerd\nBedford";
locMappings[47] = "Jadwin Gym\nCaldwell\nDeNunzio\nWeaver\nFrelinghuysen\nStadium\nPowers";
locMappings[48] = "Lewis\nLewis Library\nPeyton";
locMappings[49] = "Clarke\nFinney\nCampbell Field\nSexton Field\nStrubing\nFitzRandolph";
locMappings[50] = "Friend\nFriend Center\nComputer Science\nCOS\nCompSci\nSherrerd\nMudd\nMudd Library\nORFE";
locMappings[51] = "Edwards\nDodd";

 function monthToDays(month) {
  var d;
  switch(month) {
    case 1:
      d = 0;
      break;
    case 2:
      d = 31;
      break;
    case 3:
      d = 31+28;
      break;
    case 4:
      d = 31+28+31;
      break;
    case 5:
      d = 31+28+31+30;
      break;
    case 6:
      d = 31+28+31+30+31;
      break;
    case 7:
      d = 31+28+31+30+31+30;
      break;
    case 8:
      d = 31+28+31+30+31+30+31;
      break;
    case 9:
      d = 31+28+31+30+31+30+31+31;
      break;
    case 10:
      d = 31+28+31+30+31+30+31+31+30;
      break;
    case 11:
      d = 31+28+31+30+31+30+31+31+30+31;
      break;
    case 12:
      d = 31+28+31+30+31+30+31+31+30+31+30;
      break;
    default:
      d = 0;
      break;
  }
  return d;
}

$(function() {
  var $container = $('#right');


  $container.imagesLoaded( function() {

    /* serialize the form information and search existing items */
  var checkForMatches = 1;
  $('#yo').submit(function() {
    if (checkForMatches == 0) {
      return;
    }
      /* serialize form info */
      var myobj = $(this).serializeArray();
      var loc='';
      var name='';
      var cat='';
      var date='';
      var desc='';
      var lost='';
      var found='';

      $.each(myobj, function(ind, indVal){

        if (indVal.name == 'status') {
          if (indVal.value == 'Lost') {
            found = true;
          }
          else if (indVal.value == 'Found') {
            lost = true;
          }
        }
        if (indVal.name == 'name') {
          name = indVal.value;
        }
        if (indVal.name == 'loc') {
          loc = indVal.value;
        }
        if (indVal.name == 'category') {
          cat = indVal.value;
        }
        if (indVal.name == 'event_date') {
          date = indVal.value;
        }
        if (indVal.name == 'desc') {
          desc = indVal.desc;
        }

      });
      if (((!found && !lost) || name=='') || desc=='') {
        $('#submitModal').modal("show");
        return;
      }

        var locY;
        var nameY;
        var catY; 
        var dateY;
        var descY;
        var nw = true;

        if (loc!='') {locY = true;}

        else locY = false;
        if (name!='') {nameY = true;}
        else nameY = false;
        if (cat!='') {catY = true;}
        else catY = false;
        if (date!='') {dateY = true;}
        else dateY = false;
        
        descY = false;

        var ret;
        var count = 0;
        var namewords = name.split(" ");

        $.getJSON("../data/", function(ret) {
          $.each(ret, function(index, item){

            if (lost && !item.fields.status) {return true;}
            if (found && item.fields.status) {return true;}

            if (catY && item.fields.category!=cat) return true;
            if (locY && item.fields.location!=loc) return true;

            if (item.fields.event_date==null && dateY) return true;

            if ((fd || nw) || nm) {
              if (dateY) {
                var eDay = parseInt(item.fields.event_date.substring(8, 10), 10);
                var fDay = parseInt(date.substring(8, 10), 10);
                var eMonth = parseInt(item.fields.event_date.substring(5, 7), 10);
                var fMonth = parseInt(date.substring(5, 7), 10);
                var eYear = parseInt(item.fields.event_date.substring(0, 4), 10);
                var fYear = parseInt(date.substring(0, 4), 10);
                var eDayVal = monthToDays(eMonth) + eDay; //+ eYear*365;
                var fDayVal = monthToDays(fMonth) + fDay; // + fYear*365;

                var dist = Math.abs(fDayVal-eDayVal);
                if (dist > 365) dist = dist - 365; // seems to work
                if (fd && (dist > 3)) {
                  return true;
                }
                if (nw && (dist > 7)) {
                  return true;
                }
                if (nm && (dist > 30)) {
                  return true;
                }
                if (eYear != fYear) {
                  return true;
                }
              }
            }

            if (nameY) {
              var find = false;
              $.each(namewords, function(index, element){
                var blah = item.fields.name.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (descY) {
              var find = false;
              $.each(keywords, function(index, element){
                var blah = item.fields.desc.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

          $('.masonryImage').each(function() {
              if ($(this).attr("value")==item.pk) {
                $(this).addClass('shown');
                  count++;
              }
           });

        });
        /* now show dem! */
        /* pop up a new modal */
        if (count > 0) {
          var html = $('.shown:first').html();
          $('#matchModal').append("<div class=\'masonryImage\'>" + html + "</div>");
          if (count > 1) {
            html = $('.shown').eq(2).html();
            $('#matchModal').append("<div class=\'masonryImage\'>" + html + "</div>");
          }
          $('#matchModal').modal("show");
        }
        $('.masonryImage').each(function() {
          if ($(this).hasClass('shown')) {
            $(this).removeClass('shown');
          }
        });
        if (count == 0) {
          checkForMatches = 0;
          $('#yo').submit();
          checkForMatches = 1;
          return;
        }
      });
      return false;
    });

    $('#matchsub').click(function() {
      checkForMatches = 0;
      $('#yo').submit();
      checkForMatches = 1;
    });

    /* Open submit modal upon reloading if errors occurred */
    {% if errors %}
      $('#submitModal').modal("show");
    {% endif %}

    /* Pass data to claim modal */
    var $but = $('.btn.btn-mini.claim');
    $but.click( function() {
      $('.modal-footer.claiming #id').val(this.value);
      $('.modal-footer.claiming #status').val(this.name);
    });

    {% if options != 0 %}
      $('#thanksModal').modal("show");
    {% endif %}

    /* Pass data to resolve modal */
    var $res = $('.btn.btn-mini.resolve');
    $res.click( function() {
      $('.modal-footer.resolving #id').val(this.value);
    });

      var $location = $('#loc');
      original_loc = $location.val();
      $location.focus(function(){
        if($(this).val()===original_loc){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_loc);
        }
      });

      var $title = $('#title');
      original_tit = $title.val();
      $title.focus(function(){
        if($(this).val()===original_tit){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_tit);
        }
      });

      var $search = $('#search');
      original_val = $search.val();
      $search.focus(function(){
        if($(this).val()===original_val){

          $(this).val('');
        }
      })
      .blur(function(){
        if($(this).val()===''){

          $(this).val(original_val);
        }
      });
      /* $search.keypress(function(){
        alert("blah");
        if($(this).val()===''){
          $container.isotope({ 

          });
        } 
      }); */

      $search.keyup(function(e) {
        if (e.keyCode == 8) {
          /*$('.masonryImage').each(function() {
            if ($(this).is(":contains('" + input + "')")) {
                $(this).removeClass('shown');
            }
          });*/
          $container.isotope({filter: "*"});
          return false;
        }
      });
      $search.keypress(function (e) {
        if (e.which == 13) {
          /* do the searching here */
          /* make the http request for json data, then parse */
          var ret;
          var count = 0;
          var input = $(this).val();
          /*
          $.getJSON("../data/", function(ret){
            $.each(ret, function(index, item){

              if (item.fields.category===input) {
                $('.masonryImage').each(function() {
                  if ($(this).attr("value")==item.pk) {
                    $(this).addClass('shown');
                    count++;
                  }
                })
              }
            });
          });*/
          /* see if input matches an extant mapping */
          var x;
          var matched = 0;
          for (var i = 0; i < locMappings.length; i++) {
            x = locMappings[i].split('\n');
            for (var j = 0; j < x.length; j++) {
              if (input.toLowerCase() == x[j].toLowerCase()) {
                matched = 1;
              }
            }
            if (matched == 1) break;
          }
          /* x is now mapping that matches */

          $('.masonryImage').each(function() {
            if (matched == 1) {
              for (var k = 0; k < x.length; k++) {
                var test = x[k].toLowerCase();
                if ($(this).is(":Contains('" + test + "')")) {
                  $(this).addClass('shown');
                  count++;
                }
              }
            }
            else {
              if ($(this).is(":Contains('" + input.toLowerCase() + "')")) {
                $(this).addClass('shown');
                count++;
              }
            }
            });
            if (count === 0) {
               alert("No items match your search criteria.");
            }
            else {
             $container.isotope({ filter: ".shown"});
              $('.masonryImage').each(function() {
                if ($(this).hasClass('shown')) {
                $(this).removeClass('shown');
                }
              });
            }

          return false;
        }
      });  

      $container.isotope({

      });

      $('#filters a').click(function(){
        var selector = $(this).attr('data-filter');
        $container.isotope({ filter: selector });
        return false;
      });

      $('#advSearch').click(function() {
        var location = $('#loc').val();
        var name = $('#title').val();
        var category = $('#cats').val();
        var date = $('#date').val();
        var descbox = $('#descbox').val();
        var lost = $('#lf1').is(":checked");
        var found = $('#lf2').is(":checked");
        var nd = $('#1d').is(":checked");
        var fd = $('#fd').is(":checked");
        var nw = $('#1w').is(":checked");
        var nm = $('#1m').is(":checked");
        var locY;
        var nameY;
        var catY; 
        var dateY;
        var descY;

        if (location!="e.g. Frist") {
          locY = true;
        }
        else locY = false;
        if (name!="e.g. Black North Face Jacket") {nameY = true;}
        else nameY = false;
        if (category!=null) {catY = true;}
        else catY = false;
        if (date!="") {dateY = true;}
        else dateY = false;
        if (descbox!="") {descY = true;}
        else descY = false;

        var ret;
        var count = 0;
        var keywords = descbox.split("\n");
        var namewords = name.split(" ");

        $.getJSON("../data/", function(ret){
          $.each(ret, function(index, item){
           /* alert('item');
            alert('locY'+locY);
            alert('location field' + )
            alert('nameY' + nameY);
            alert('catY' + catY);
            alert('dateY' + dateY);
            alert(lost + 'field:' + item.fields.status)*/

            if (lost && !item.fields.status) {return true;}
            if (found && item.fields.status) {return true;}

            if (catY && item.fields.category!=category[0]) return true;
            if (locY && item.fields.location!=location) return true;

            /* date handling */
            if (item.fields.event_date==null && dateY) return true;
            if ((nd && dateY) && (item.fields.event_date!=date)) return true;
            if ((fd || nw) || nm) {
              if (dateY) {
                /* e is event, f is form input - 10 is to prevent octal */
                var eDay = parseInt(item.fields.event_date.substring(8, 10), 10);
                var fDay = parseInt(date.substring(8, 10), 10);
                var eMonth = parseInt(item.fields.event_date.substring(5, 7), 10);
                var fMonth = parseInt(date.substring(5, 7), 10);
                var eYear = parseInt(item.fields.event_date.substring(0, 4), 10);
                var fYear = parseInt(date.substring(0, 4), 10);
                /* convert date to easier format */
                var eDayVal = monthToDays(eMonth) + eDay; //+ eYear*365;
                var fDayVal = monthToDays(fMonth) + fDay; // + fYear*365;

                var dist = Math.abs(fDayVal-eDayVal);
                if (dist > 365) dist = dist - 365; // seems to work
                if (fd && (dist > 3)) {
                  return true;
                }
                if (nw && (dist > 7)) {
                  return true;
                }
                if (nm && (dist > 30)) {
                  return true;
                }
                if (eYear != fYear) {
                  return true;
                }
              }
            }


            if (nameY) {
              var find = false;
              $.each(namewords, function(index, element){
                var blah = item.fields.name.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

            if (descY) {
              var find = false;
              $.each(keywords, function(index, element){
                var blah = item.fields.desc.toLowerCase();
                if (blah.indexOf(element.toLowerCase()) >= 0) {
                  find = true;
                }
              });
              if (find==false) { return true;}
            }

          /* I don't know why this needs to be here */
          $('.masonryImage').each(function() {
              if ($(this).attr("value")==item.pk) {
                $(this).addClass('shown');
                  count++;
              }
           });


          });
            $container.isotope({ filter: ".shown"});
             /* reset */
            $('.masonryImage').each(function() {
              if ($(this).hasClass('shown')) {
                $(this).removeClass('shown');
              }
            });

        });
        return false;
      });

    });
  });

</script>

{% endblock %}
